// ============================================================================
// gui64.c - VESA Framebuffer GUI with DOUBLE BUFFERING
// ============================================================================
#include <stddef.h>
#include "gui64.h"

static uint32_t* fb = NULL;
static uint32_t pixels_per_row = 0;

// DOUBLE BUFFER - Optimized for terminal dragging
static uint32_t* back_buffer = NULL;
static bool use_back_buffer = false;

// 8x10 Font (2 satır boşluk eklendi)
// 8x14 Font (6 satır boşluk eklendi)
static const uint8_t font_8x14[96][14] = {
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, {0x18,0x3C,0x3C,0x18,0x18,0x00,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    {0x6C,0x6C,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, {0x6C,0x6C,0xFE,0x6C,0xFE,0x6C,0x6C,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    {0x30,0x7C,0xC0,0x78,0x0C,0xF8,0x30,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, {0x00,0xC6,0xCC,0x18,0x30,0x66,0xC6,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    {0x38,0x6C,0x38,0x76,0xDC,0xCC,0x76,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, {0x60,0x60,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    {0x18,0x30,0x60,0x60,0x60,0x30,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, {0x60,0x30,0x18,0x18,0x18,0x30,0x60,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    {0x00,0x66,0x3C,0xFF,0x3C,0x66,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, {0x00,0x30,0x30,0xFC,0x30,0x30,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    {0x00,0x00,0x00,0x00,0x00,0x30,0x30,0x60,0x00,0x00,0x00,0x00,0x00,0x00}, {0x00,0x00,0x00,0xFC,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    {0x00,0x00,0x00,0x00,0x00,0x30,0x30,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, {0x06,0x0C,0x18,0x30,0x60,0xC0,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    {0x7C,0xC6,0xCE,0xDE,0xF6,0xE6,0x7C,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, {0x30,0x70,0x30,0x30,0x30,0x30,0xFC,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    {0x78,0xCC,0x0C,0x38,0x60,0xCC,0xFC,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, {0x78,0xCC,0x0C,0x38,0x0C,0xCC,0x78,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    {0x1C,0x3C,0x6C,0xCC,0xFE,0x0C,0x1E,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, {0xFC,0xC0,0xF8,0x0C,0x0C,0xCC,0x78,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    {0x38,0x60,0xC0,0xF8,0xCC,0xCC,0x78,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, {0xFC,0xCC,0x0C,0x18,0x30,0x30,0x30,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    {0x78,0xCC,0xCC,0x78,0xCC,0xCC,0x78,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, {0x78,0xCC,0xCC,0x7C,0x0C,0x18,0x70,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    {0x00,0x30,0x30,0x00,0x00,0x30,0x30,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, {0x00,0x30,0x30,0x00,0x00,0x30,0x30,0x60,0x00,0x00,0x00,0x00,0x00,0x00},
    {0x18,0x30,0x60,0xC0,0x60,0x30,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, {0x00,0x00,0xFC,0x00,0x00,0xFC,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    {0x60,0x30,0x18,0x0C,0x18,0x30,0x60,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, {0x78,0xCC,0x0C,0x18,0x30,0x00,0x30,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    {0x7C,0xC6,0xDE,0xDE,0xDE,0xC0,0x78,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    {0x30,0x78,0xCC,0xCC,0xFC,0xCC,0xCC,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, {0xFC,0x66,0x66,0x7C,0x66,0x66,0xFC,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    {0x3C,0x66,0xC0,0xC0,0xC0,0x66,0x3C,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, {0xF8,0x6C,0x66,0x66,0x66,0x6C,0xF8,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    {0xFE,0x62,0x68,0x78,0x68,0x62,0xFE,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, {0xFE,0x62,0x68,0x78,0x68,0x60,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    {0x3C,0x66,0xC0,0xC0,0xCE,0x66,0x3E,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, {0xCC,0xCC,0xCC,0xFC,0xCC,0xCC,0xCC,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    {0x78,0x30,0x30,0x30,0x30,0x30,0x78,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, {0x1E,0x0C,0x0C,0x0C,0xCC,0xCC,0x78,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    {0xE6,0x66,0x6C,0x78,0x6C,0x66,0xE6,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, {0xF0,0x60,0x60,0x60,0x62,0x66,0xFE,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    {0xC6,0xEE,0xFE,0xFE,0xD6,0xC6,0xC6,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, {0xC6,0xE6,0xF6,0xDE,0xCE,0xC6,0xC6,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    {0x38,0x6C,0xC6,0xC6,0xC6,0x6C,0x38,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, {0xFC,0x66,0x66,0x7C,0x60,0x60,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    {0x78,0xCC,0xCC,0xCC,0xDC,0x78,0x1C,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, {0xFC,0x66,0x66,0x7C,0x6C,0x66,0xE6,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    {0x78,0xCC,0xE0,0x70,0x1C,0xCC,0x78,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, {0xFC,0xB4,0x30,0x30,0x30,0x30,0x78,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    {0xCC,0xCC,0xCC,0xCC,0xCC,0xCC,0xFC,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, {0xCC,0xCC,0xCC,0xCC,0xCC,0x78,0x30,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    {0xC6,0xC6,0xC6,0xD6,0xFE,0xEE,0xC6,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, {0xC6,0xC6,0x6C,0x38,0x38,0x6C,0xC6,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    {0xCC,0xCC,0xCC,0x78,0x30,0x30,0x78,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, {0xFE,0xC6,0x8C,0x18,0x32,0x66,0xFE,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    {0x78,0x60,0x60,0x60,0x60,0x60,0x78,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, {0xC0,0x60,0x30,0x18,0x0C,0x06,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    {0x78,0x18,0x18,0x18,0x18,0x18,0x78,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, {0x10,0x38,0x6C,0xC6,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00}, {0x30,0x30,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    {0x00,0x00,0x78,0x0C,0x7C,0xCC,0x76,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, {0xE0,0x60,0x60,0x7C,0x66,0x66,0xDC,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    {0x00,0x00,0x78,0xCC,0xC0,0xCC,0x78,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, {0x1C,0x0C,0x0C,0x7C,0xCC,0xCC,0x76,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    {0x00,0x00,0x78,0xCC,0xFC,0xC0,0x78,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, {0x38,0x6C,0x60,0xF0,0x60,0x60,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    {0x00,0x00,0x76,0xCC,0xCC,0x7C,0x0C,0xF8,0x00,0x00,0x00,0x00,0x00,0x00}, {0xE0,0x60,0x6C,0x76,0x66,0x66,0xE6,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    {0x30,0x00,0x70,0x30,0x30,0x30,0x78,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, {0x0C,0x00,0x0C,0x0C,0x0C,0xCC,0xCC,0x78,0x00,0x00,0x00,0x00,0x00,0x00},
    {0xE0,0x60,0x66,0x6C,0x78,0x6C,0xE6,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, {0x70,0x30,0x30,0x30,0x30,0x30,0x78,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    {0x00,0x00,0xCC,0xFE,0xFE,0xD6,0xC6,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, {0x00,0x00,0xF8,0xCC,0xCC,0xCC,0xCC,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    {0x00,0x00,0x78,0xCC,0xCC,0xCC,0x78,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, {0x00,0x00,0xDC,0x66,0x66,0x7C,0x60,0xF0,0x00,0x00,0x00,0x00,0x00,0x00},
    {0x00,0x00,0x76,0xCC,0xCC,0x7C,0x0C,0x1E,0x00,0x00,0x00,0x00,0x00,0x00}, {0x00,0x00,0xDC,0x76,0x66,0x60,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    {0x00,0x00,0x7C,0xC0,0x78,0x0C,0xF8,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, {0x10,0x30,0x7C,0x30,0x30,0x34,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    {0x00,0x00,0xCC,0xCC,0xCC,0xCC,0x76,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, {0x00,0x00,0xCC,0xCC,0xCC,0x78,0x30,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    {0x00,0x00,0xC6,0xD6,0xFE,0xFE,0x6C,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, {0x00,0x00,0xC6,0x6C,0x38,0x6C,0xC6,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    {0x00,0x00,0xCC,0xCC,0xCC,0x7C,0x0C,0xF8,0x00,0x00,0x00,0x00,0x00,0x00}, {0x00,0x00,0xFC,0x98,0x30,0x64,0xFC,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    {0x1C,0x30,0x30,0xE0,0x30,0x30,0x1C,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, {0x18,0x18,0x18,0x00,0x18,0x18,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    {0xE0,0x30,0x30,0x1C,0x30,0x30,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, {0x76,0xDC,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
};

void gui_init(void) {
    fb = (uint32_t*)framebuffer_addr;
    pixels_per_row = framebuffer_pitch / 4;
    
    // Allocate back buffer (800x600x4 bytes = ~1.9MB)
    // Use safe memory area at 5MB
    back_buffer = (uint32_t*)0x500000;
    use_back_buffer = false;
}

// START DRAWING TO BACK BUFFER (full screen copy)
void gui_begin_frame(void) {
    use_back_buffer = true;
    
    // Copy current screen to back buffer
    // This is fast enough - ~2ms for 800x600
    uint32_t total = framebuffer_height * pixels_per_row;
    for (uint32_t i = 0; i < total; i++) {
        back_buffer[i] = fb[i];
    }
}

// COPY BACK BUFFER TO SCREEN (full screen)
void gui_end_frame(void) {
    if (!use_back_buffer) return;
    
    // Copy entire back buffer in one go
    uint32_t total = framebuffer_height * pixels_per_row;
    for (uint32_t i = 0; i < total; i++) {
        fb[i] = back_buffer[i];
    }
    
    use_back_buffer = false;
}

int gui_get_width(void) { return (int)framebuffer_width; }
int gui_get_height(void) { return (int)framebuffer_height; }

bool gui_is_valid_coord(int x, int y) {
    return x >= 0 && x < (int)framebuffer_width && 
           y >= 0 && y < (int)framebuffer_height;
}

void gui_clear(Color color) {
    uint32_t* target = use_back_buffer ? back_buffer : fb;
    for (uint32_t i = 0; i < framebuffer_height * pixels_per_row; i++)
        target[i] = color;
}

void gui_put_pixel(int x, int y, Color color) {
    if (!gui_is_valid_coord(x, y)) return;
    
    if (use_back_buffer) {
        back_buffer[y * pixels_per_row + x] = color;
    } else {
        fb[y * pixels_per_row + x] = color;
    }
}

Color gui_get_pixel(int x, int y) {
    if (!gui_is_valid_coord(x, y)) return COLOR_BLACK;
    
    if (use_back_buffer) {
        return back_buffer[y * pixels_per_row + x];
    } else {
        return fb[y * pixels_per_row + x];
    }
}

void gui_draw_line(int x1, int y1, int x2, int y2, Color color) {
    int dx = (x2>x1)?(x2-x1):(x1-x2), dy = (y2>y1)?(y2-y1):(y1-y2);
    int sx = (x1<x2)?1:-1, sy = (y1<y2)?1:-1, err = dx-dy;
    while (1) {
        gui_put_pixel(x1, y1, color);
        if (x1==x2 && y1==y2) break;
        int e2 = 2*err;
        if (e2>-dy) { err-=dy; x1+=sx; }
        if (e2<dx) { err+=dx; y1+=sy; }
    }
}

void gui_fill_rect(int x, int y, int w, int h, Color color) {
    for (int py=y; py<y+h; py++)
        for (int px=x; px<x+w; px++)
            gui_put_pixel(px, py, color);
}

Color gui_blend_colors(Color fg, Color bg, uint8_t alpha) {
    uint8_t r = (GET_RED(fg)*alpha + GET_RED(bg)*(255-alpha))/255;
    uint8_t g = (GET_GREEN(fg)*alpha + GET_GREEN(bg)*(255-alpha))/255;
    uint8_t b = (GET_BLUE(fg)*alpha + GET_BLUE(bg)*(255-alpha))/255;
    return RGB(r, g, b);
}

Color gui_darken_color(Color color, float factor) {
    uint8_t r = (uint8_t)(GET_RED(color) * factor);
    uint8_t g = (uint8_t)(GET_GREEN(color) * factor);
    uint8_t b = (uint8_t)(GET_BLUE(color) * factor);
    return RGB(r, g, b);
}

void gui_draw_char(int x, int y, char c, Color fg, Color bg) {
    unsigned char uc = (unsigned char)c;
    if (uc<32 || uc>127) uc = ' ';
    const uint8_t* glyph = font_8x14[uc-32];
    for (int row=0; row<8; row++)
        for (int col=0; col<8; col++)
            gui_put_pixel(x+col, y+row, (glyph[row]&(1<<(7-col)))?fg:(bg?bg:gui_get_pixel(x+col,y+row)));
}

void gui_draw_string(int x, int y, const char* str, Color fg, Color bg) {
    while (*str) { gui_draw_char(x, y, *str, fg, bg); x+=8; str++; }
}

void gui_draw_cursor(int x, int y) {
    static const int cursor_data[17][2] = {
        {2,0},{3,0},{4,0},{5,0},{6,0},{7,0},{8,0},{9,0},{10,0},
        {9,0},{8,0},{6,2},{6,2},{5,3},{4,4},{3,5},{2,6}
    };
    for (int row=0; row<17; row++) {
        int w = cursor_data[row][0], off = cursor_data[row][1];
        for (int col=0; col<=w+1; col++) {
            if (col==0 || col==w+1 || row==0 || row==16)
                gui_put_pixel(x+off+col, y+row, COLOR_BLACK);
        }
    }
    for (int row=1; row<16; row++) {
        int w = cursor_data[row][0], off = cursor_data[row][1];
        for (int col=1; col<=w; col++)
            gui_put_pixel(x+off+col, y+row, COLOR_WHITE);
    }
}

void gui_draw_window(const Window* win) {
    if (!win->visible) return;
    gui_fill_rect(win->x+4, win->y+4, win->width, win->height, gui_darken_color(COLOR_BLACK, 0.3f));
    gui_fill_rect(win->x, win->y, win->width, win->height, win->bg_color);
    gui_fill_rect(win->x, win->y, win->width, 24, win->border_color);
    gui_draw_string(win->x+8, win->y+8, win->title, COLOR_WHITE, 0);
}

// RTC
#define RTC_ADDR 0x70
#define RTC_DATA 0x71

static inline void outb(uint16_t port, uint8_t val) {
    __asm__ volatile ("outb %0, %1" : : "a"(val), "Nd"(port));
}

static inline uint8_t inb(uint16_t port) {
    uint8_t ret;
    __asm__ volatile ("inb %1, %0" : "=a"(ret) : "Nd"(port));
    return ret;
}

static uint8_t bcd_to_decimal(uint8_t bcd) {
    return ((bcd >> 4) * 10) + (bcd & 0x0F);
}

void gui_get_rtc_time(uint8_t* hours, uint8_t* minutes, uint8_t* seconds) {
    outb(RTC_ADDR, 0x00);
    uint8_t sec = inb(RTC_DATA);
    outb(RTC_ADDR, 0x02);
    uint8_t min = inb(RTC_DATA);
    outb(RTC_ADDR, 0x04);
    uint8_t hour = inb(RTC_DATA);
    
    *seconds = bcd_to_decimal(sec);
    *minutes = bcd_to_decimal(min);
    *hours = bcd_to_decimal(hour);
}

static void num_to_str2(uint8_t num, char* buf) {
    buf[0] = '0' + (num / 10);
    buf[1] = '0' + (num % 10);
    buf[2] = '\0';
}

void gui_draw_clock(int x, int y, uint8_t hours, uint8_t minutes, uint8_t seconds) {
    const int width = 140;
    const int height = 32;
    
    gui_fill_rect(x + 3, y + 3, width, height, gui_darken_color(COLOR_BLACK, 0.5f));
    gui_fill_rect(x, y, width, height, RGB(40, 40, 50));
    
    gui_draw_line(x, y, x + width - 1, y, RGB(80, 80, 90));
    gui_draw_line(x, y, x, y + height - 1, RGB(80, 80, 90));
    gui_draw_line(x + width - 1, y, x + width - 1, y + height - 1, RGB(20, 20, 30));
    gui_draw_line(x, y + height - 1, x + width - 1, y + height - 1, RGB(20, 20, 30));
    
    char time_str[16];
    char h_str[3], m_str[3], s_str[3];
    
    num_to_str2(hours, h_str);
    num_to_str2(minutes, m_str);
    num_to_str2(seconds, s_str);
    
    int idx = 0;
    time_str[idx++] = h_str[0];
    time_str[idx++] = h_str[1];
    time_str[idx++] = ':';
    time_str[idx++] = m_str[0];
    time_str[idx++] = m_str[1];
    time_str[idx++] = ':';
    time_str[idx++] = s_str[0];
    time_str[idx++] = s_str[1];
    time_str[idx] = '\0';
    
    int text_x = x + 10;
    int text_y = y + 8;
    const Color text_color = RGB(0, 255, 100);
    
    for (int i = 0; time_str[i]; i++) {
        for (int py = 0; py < 8; py++) {
            for (int px = 0; px < 8; px++) {
                unsigned char uc = (unsigned char)time_str[i];
                if (uc < 32 || uc > 127) uc = ' ';
                const uint8_t* glyph = font_8x14[uc - 32];
                
                if (glyph[py] & (1 << (7 - px))) {
                    gui_put_pixel(text_x + px * 2, text_y + py * 2, text_color);
                    gui_put_pixel(text_x + px * 2 + 1, text_y + py * 2, text_color);
                    gui_put_pixel(text_x + px * 2, text_y + py * 2 + 1, text_color);
                    gui_put_pixel(text_x + px * 2 + 1, text_y + py * 2 + 1, text_color);
                }
            }
        }
        text_x += 16;
    }
}